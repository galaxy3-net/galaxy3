#!/bin/bash

cat <<__EOD__

  Installing XRDP

__EOD__

function setup_iptables () {
  # ls /etc/init.d/turn_off_iptables ||
  cat <<__EOD__ >/etc/init.d/turn_off_iptables
#!/usr/bin/env bash
iptables -I INPUT -p tcp --dport 3389 -j ACCEPT
#service iptables save
#iptables restart
__EOD__

  #    iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
  #    iptables -A INPUT -p tcp --dport 3389 -m state --state NEW -j ACCEPT
  #    iptables -A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
  #    iptables -A OUTPUT -p tcp --dport 3389 -m state --state NEW -j ACCEPT
  #     iptables -F
  #     iptables -X
  #     iptables -P INPUT ACCEPT
  #     iptables -P OUTPUT ACCEPT
  #     iptables -P FORWARD ACCEPT

  ls -dl /etc/rc3.d/S99iptables || ln -s /etc/init.d/turn_off_iptables /etc/rc3.d/S99iptables

  chmod u+x /etc/init.d/turn_off_iptables
  ls -l /etc/rc3.d/S99iptables
  ls -l /etc/init.d/turn_off_iptables
  /etc/rc3.d/S99iptables
  return
}

function install_pkgs () {
  case $(hostname) in

    "naboo")
      apt-get install -yq -o Dpkg::Options::='--force-confold' --force-yes xrdp xorgxrdp-hwe-18.04 xfce4 xfce4-goodies #  xfonts-100dpi xfonts-75dpi xfonts-traditional \
      # xfonts-terminus-dos xfonts-mona xfonts-efont-unicode 2>&1 >>/var/log/install.log
      ;;

    "*") apt-get install -yq xrdp
      systemctl enable xrdp
      systemctl start xrdp
      ;;

  esac

  adduser xrdp ssl-cert
  adduser xrdp tty


  return
}

function extras () {
     mkdir -p /home/vagrant/.vnc

     cat <<__EOD__ > /home/vagrant/.vnc/xstartup
#!/bin/bash
xrdb /home/vagrant/.Xresources
startxfce4 &
__EOD__



     chown -R vagrant:vagrant /home/vagrant/.vnc/
     chmod u+x /home/vagrant/.vnc/xstartup

    return
}

function update_xwrapper () {
cat <<__EOD__ > /etc/X11/Xwrapper.config
# Xwrapper.config (Debian X Window System server wrapper configuration file)
#
# This file was generated by the post-installation script of the
# xserver-xorg-legacy package using values from the debconf database.
#
# See the Xwrapper.config(5) manual page for more information.
#
# This file is automatically updated on upgrades of the xserver-xorg-legacy
# package *only* if it has not been modified since the last upgrade of that
# package.
#
# If you have edited this file but would like it to be automatically updated
# again, run the following command as root:
#   dpkg-reconfigure xserver-xorg-legacy
allowed_users=anybody
needs_root_rights=no
__EOD__

  return
}

case $(hostname) in


  "naboo")
    install_pkgs
    setup_iptables
    ;;

  *) which ufw && ufw allow 53
    ;;
esac

#  References
#
#  https://www.digitalocean.com/community/tutorials/how-to-install-and-configure-vnc-on-ubuntu-16-04
